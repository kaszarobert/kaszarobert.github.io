var scanner;var activeCamera;var isQrCheckingActive=false;var SERVER="https://qrsys.ddns.net";var screens={LOGIN:1,LOGOUT:2,MAINMENU:3,SCANQR_ENTER:4,SCANQR_ENTER_PIN:5,SCANQR_EXIT:6,LISTSERVICES:7,SCANQR_USESERVICE:8,SCANQR_USESERVICE_PIN:9};var notificationStyles={SUCCESS:"success",INFO:"info",WARN:"warn",ERROR:"error"};var readQrData;var selectedPrice={};var currentScreen;var authorizingInterval;var REAUTHORIZE_TIME=1000*60*59;var darkMode=false;var styles;$(document).ready(function(){initStyle();loadQrScanner();tryToAuthenticateAutomatically();assignAction();});function tryToAuthenticateAutomatically(){var terminalReferenceNumber=getTerminalRefNumberFromToken();if(terminalReferenceNumber==""){removeStoredData();changeScreenLogin();}else{var url=SERVER+"/qrsys/rest/rpi/reauthorize";var req={};req.terminalReferenceNumber=terminalReferenceNumber;sendAjax("POST",url,JSON.stringify(req),function(xhr){xhr.setRequestHeader('Authorization',getStoredData("Authorization"));},null,function(xhr){if(xhr.status==200){var token=xhr.getResponseHeader("Authorization");if(token){setStoredData("Authorization",token);}
startBackGroundReAuthorizing();changeScreenMenu();}else{removeStoredData();changeScreenLogin();}});}}
function getTerminalRefNumberFromToken(){var token=getStoredData("Authorization");if(token==null||token==""){return"";}else{try{var decoded=jwt_decode(token);}catch(e){return"";}
return decoded.aud;}}
function initStyle(){styles={light:$("#light"),dark:$("#dark")};var useDarkTheme=getStoredData("DARKTHEME");if(useDarkTheme==""){$("#dark").detach();darkMode=false;setStoredData("DARKTHEME",darkMode);}else if(useDarkTheme=="true"){$("#light").detach();darkMode=true;}else{$("#dark").detach();darkMode=false;}}
function switchToTheOtherStyle(){if(darkMode){$("#dark").detach();styles.light.appendTo("head");}else{$("#light").detach();styles.dark.appendTo("head");}
darkMode=!darkMode;setStoredData("DARKTHEME",darkMode);}
function hideAllExcept(divId,menuVisible){$('#terminalWrapper div').not("#"+divId).hide();$("#"+divId).show();$("#themeChoosing").show();if(menuVisible){$("#terminalMenuBackButton").show();}else{$("#terminalMenuBackButton").hide();}}
function assignAction(){$("#loginBtn").click(function(e){e.preventDefault();app_login($("#loginQr").val(),$("#loginPass").val(),$("#loginRefnum").val());});$("#exitBtn").click(function(e){e.preventDefault();changeScreenExit();});$("#logoutBtn").click(function(e){e.preventDefault();app_logout();});$("#enterBtn").click(function(e){e.preventDefault();changeScreenEnter();});$("#szolgBtn").click(function(e){e.preventDefault();changeScreenServicesList();});$("#enterSubmit").click(function(e){e.preventDefault();app_sendEnterRequest(readQrData,$("#enterPass").val());});$("#serviceUseSubmit").click(function(e){e.preventDefault();app_useService(readQrData,$("#serviceUsePass").val());});$("#backToMenu").click(function(e){e.preventDefault();changeScreenMenu();});$("#setOtherTheme").click(function(e){e.preventDefault();switchToTheOtherStyle();});}
function assignServicesListClickers(){$('.clicker').click(function(){$(this).nextUntil('.clicker').slideToggle('normal');});$("tr[id^='p']").each(function(){$(this).click(function(){selectedPrice.id=$(this).attr("id").substring(1);selectedPrice.description=$(this).find(':first-child').text();selectedPrice.amount=$(this).find("td:nth-child(2)").text();;changeScreenServicesScanForQr();});});}
function loadQrScanner(){scanner=new Instascan.Scanner({video:document.getElementById('preview')});scanner.addListener('scan',function(content){readQrData=content;switch(currentScreen){case screens.SCANQR_ENTER:app_sendEnterRequest(content,"");break;case screens.SCANQR_EXIT:app_exit(content);break;case screens.SCANQR_USESERVICE:if(askUserIsItOkToUseTheService(selectedPrice.amount,selectedPrice.description)){changeScreenServicesEnterPin();}
break;}});Instascan.Camera.getCameras().then(function(cameras){if(cameras.length>0){activeCamera=cameras[0];}else{console.error('No cameras found.');}}).catch(function(e){console.error(e);});}
function startQrScanner(){if(!isQrCheckingActive){scanner.start(activeCamera);isQrCheckingActive=true;}}
function stopQrScanner(){if(isQrCheckingActive){scanner.stop(activeCamera);isQrCheckingActive=false;}}
function changeScreenLogin(){hideAllExcept("terminalLoginScreen",false);currentScreen=screens.LOGIN;stopQrScanner();selectedPrice={};}
function changeScreenMenu(){stopQrScanner();hideAllExcept("terminalMenuScreen",false);currentScreen=screens.MAINMENU;readQrData="";selectedPrice={};}
function changeScreenLogout(){changeScreenLogin();}
function changeScreenEnter(){startQrScanner();hideAllExcept("qrScanPreview",true);currentScreen=screens.SCANQR_ENTER;readQrData="";}
function changeScreenEnterPin(){stopQrScanner();hideAllExcept("terminalEnterScreen",true);currentScreen=screens.SCANQR_ENTER_PIN;}
function changeScreenExit(){startQrScanner();hideAllExcept("qrScanPreview",true);currentScreen=screens.SCANQR_EXIT;readQrData="";}
function changeScreenServicesList(){stopQrScanner();hideAllExcept("terminalPaidServicesScreen",true);currentScreen=screens.LISTSERVICES;selectedPrice={};app_services();}
function changeScreenServicesScanForQr(){startQrScanner();hideAllExcept("qrScanPreview",true);currentScreen=screens.SCANQR_USESERVICE;readQrData="";}
function changeScreenServicesEnterPin(){stopQrScanner();hideAllExcept("terminalUseServiceScreen",true);currentScreen=screens.SCANQR_USESERVICE_PIN;}
function showNotification(message,style){$.notify(message,style);}
function app_login(qr,pass,ref){var url=SERVER+"/qrsys/rest/rpi/terminallogin";var req={};req.qrCode=qr;req.pin=pass;req.terminalReferenceNumber=ref;sendAjax("POST",url,JSON.stringify(req),null,function(data,textStatus,xhr){setStoredData("Authorization",xhr.getResponseHeader("Authorization"));var message="Terminal "+xhr.responseJSON.terminal.referenceNumber
+" logged in with account "+xhr.responseJSON.accountData.firstName
+" "+xhr.responseJSON.accountData.lastName;showNotification(message,notificationStyles.SUCCESS);changeScreenMenu();startBackGroundReAuthorizing();},function(xhr){var message=xhr.responseJSON.errorMessage;showNotification(message,notificationStyles.ERROR);});}
function app_logout(){var url=SERVER+"/qrsys/rest/rpi/terminallogout";var req={};req.terminalReferenceNumber=getTerminalRefNumberFromToken();if(req.terminalReferenceNumber==""){changeScreenLogin();removeStoredData();}else{sendAjax("POST",url,JSON.stringify(req),function(xhr){xhr.setRequestHeader('Authorization',getStoredData("Authorization"));},function(data,textStatus,xhr){var message="Terminal "+xhr.responseJSON.referenceNumber
+" logged out successfully";showNotification(message,notificationStyles.SUCCESS);removeStoredData();stopBackGroundReAuthorizing();},function(xhr){var message=xhr.responseJSON.errorMessage;showNotification(message,notificationStyles.ERROR);});changeScreenLogout();}}
function app_sendEnterRequest(qr,pass){var url=SERVER+"/qrsys/rest/rpi/enter";var req={};req.qrCode=qr;req.pin=pass;req.terminalReferenceNumber=getTerminalRefNumberFromToken();if(req.terminalReferenceNumber==""){changeScreenLogin();removeStoredData();}else{sendAjax("POST",url,JSON.stringify(req),function(xhr){xhr.setRequestHeader('Authorization',getStoredData("Authorization"));},function(data,textStatus,xhr){var message=xhr.responseJSON.accountData.firstName
+" "+xhr.responseJSON.accountData.lastName
+" entered successfully!";showNotification(message,notificationStyles.SUCCESS);setStoredData("Authorization",xhr.getResponseHeader("Authorization"));changeScreenEnter();},function(xhr){if(xhr.responseJSON.errorMessage.indexOf("Password is necessary")!==-1){changeScreenEnterPin();}else{var message=xhr.responseJSON.errorMessage;showNotification(message,notificationStyles.ERROR);changeScreenEnter();}});}}
function app_exit(qr){var url=SERVER+"/qrsys/rest/rpi/exit";var req={};req.qrCode=qr;req.terminalReferenceNumber=getTerminalRefNumberFromToken();if(req.terminalReferenceNumber==""){changeScreenLogin();removeStoredData();}else{sendAjax("POST",url,JSON.stringify(req),function(xhr){xhr.setRequestHeader('Authorization',getStoredData("Authorization"));},function(data,textStatus,xhr){var message=xhr.responseJSON.accountData.firstName
+" "+xhr.responseJSON.accountData.lastName
+" exited successfully!";showNotification(message,notificationStyles.SUCCESS);setStoredData("Authorization",xhr.getResponseHeader("Authorization"));changeScreenExit();},function(xhr){var message=xhr.responseJSON.errorMessage;showNotification(message,notificationStyles.ERROR);changeScreenExit();});}}
function app_services(){$('#servicelist').empty();var url=SERVER+"/qrsys/rest/rpi/paidservices";var token=getStoredData("Authorization");if(token==""||token==null){changeScreenLogin();removeStoredData();}else{sendAjax("GET",url,null,function(xhr){xhr.setRequestHeader('Authorization',getStoredData("Authorization"));},function(data,textStatus,xhr){setStoredData("Authorization",xhr.getResponseHeader("Authorization"));var serviceList=xhr.responseJSON;for(var i=0;i<serviceList.length;i++){var newServiceWithPrices="<tr class=\"clicker\" id=\"s"+serviceList[i].id
+"\"><td colspan=\"2\">"
+serviceList[i].title+"</td></tr>";for(var j=0;j<serviceList[i].prices.length;j++){currentPriceRow="<tr class=\"bg-primary\" id=\"p"+serviceList[i].prices[j].id
+"\" style=\"display: none;\"><td>"+serviceList[i].prices[j].description+"</td><td>"+(-serviceList[i].prices[j].amount)+"</td></tr>";newServiceWithPrices+=currentPriceRow;}
$('#servicelist').append("<tbody>"+newServiceWithPrices+"</tbody>");}
assignServicesListClickers();},function(xhr){var message=xhr.responseJSON.errorMessage;showNotification(message,notificationStyles.ERROR);});}}
function app_useService(qr,pass){var url=SERVER+"/qrsys/rest/rpi/useservice";var req={};req.qrCode=qr;req.pin=pass;req.priceId=selectedPrice.id;req.terminalReferenceNumber=getTerminalRefNumberFromToken();if(req.terminalReferenceNumber==""){changeScreenLogin();removeStoredData();}else{sendAjax("POST",url,JSON.stringify(req),function(xhr){xhr.setRequestHeader('Authorization',getStoredData("Authorization"));},function(data,textStatus,xhr){var message="Using service "+xhr.responseJSON.priceDescription
+" for "+xhr.responseJSON.firstName
+" "+xhr.responseJSON.lastName
+" is successful!";showNotification(message,notificationStyles.SUCCESS);setStoredData("Authorization",xhr.getResponseHeader("Authorization"));changeScreenServicesScanForQr();},function(xhr){var message=xhr.responseJSON.errorMessage;showNotification(message,notificationStyles.ERROR);changeScreenServicesScanForQr();});}}
function askUserIsItOkToUseTheService(price,description){return confirm("Are you sure you want to pay "+price+" for "+description+"?");}
function sleep(milliseconds){var start=new Date().getTime();for(var i=0;i<1e7;i++){if((new Date().getTime()-start)>milliseconds){break;}}}
function startBackGroundReAuthorizing(){authorizingInterval=setInterval(reAuthorize,REAUTHORIZE_TIME);}
function stopBackGroundReAuthorizing(){clearInterval(authorizingInterval);}
function reAuthorize(){console.log("Reauthorizing.");var url=SERVER+"/qrsys/rest/rpi/reauthorize";var req={};req.terminalReferenceNumber=getTerminalRefNumberFromToken();if(req.terminalReferenceNumber==""){changeScreenLogin();removeStoredData();}else{sendAjax("POST",url,JSON.stringify(req),function(xhr){xhr.setRequestHeader('Authorization',getStoredData("Authorization"));},null,function(xhr){var token=xhr.getResponseHeader("Authorization");if(token){setStoredData("Authorization",token);}});}}
function setCookie(cname,cvalue,exdays){var expires="";if(cvalue!=0&&cvalue!="0"){var d=new Date();d.setTime(d.getTime()+(exdays*24*60*60*1000));expires="expires="+d.toUTCString()+";";}
document.cookie=cname+"="+cvalue+";"+expires+"path=/";}
function getCookie(cname){var name=cname+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' '){c=c.substring(1);}
if(c.indexOf(name)==0){return c.substring(name.length,c.length);}}
return"";}
function delete_cookie(name){document.cookie=name+'=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';}
function setStoredData(name,value){localStorage.setItem(name,value);}
function getStoredData(name){return localStorage.getItem(name);}
function removeStoredData(){localStorage.removeItem("Authorization")}
function removeAllStoredDataForThisWebsite(){localStorage.clear();}